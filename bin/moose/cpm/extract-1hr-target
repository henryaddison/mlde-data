#! /usr/bin/env bash

set -euo pipefail

job_id=0

while getopts ":d:v:e:j" opt; do
  case ${opt} in
    d)
      domain=${OPTARG}
      ;;
    v)
      variable=${OPTARG}
      ;;
    e)
      ensemble_member=${OPTARG}
      ;;
    j)
      job_id=${OPTARG}
      ;;
   \? )
     echo "Invalid Option: -${OPTARG}" 1>&2
     exit 1
     ;;
  esac
done
shift $((OPTIND -1))

years=$@

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

scenario="rcp85"
scale_factor="4"
frequency="1hr"
size=64

variable_config_path="${SCRIPT_DIR}/../../../src/mlde_data/config/variables/${frequency}/land-cpm/${variable}.yml"

QUEUE_LOTUS_PATH=${SCRIPT_DIR}/../queue-lotus
LOTUS_WRAPPER_PATH=${SCRIPT_DIR}/../lotus-wrapper

function queue_years {
  local job_id=$1
  shift 1;
  local years=$@
  # Just run script in this process as mass via LOTUS is currently not working for me
  ${QUEUE_LOTUS_PATH} -j ${job_id} -d ${SCRIPT_DIR} -- ${LOTUS_WRAPPER_PATH} --variable-config ${variable_config_path} --ensemble-member ${ensemble_member} --scenario ${scenario} --domain ${domain} --scale-factor ${scale_factor} --size ${size} ${years}
  # ${LOTUS_WRAPPER_PATH} --variable-config ${variable_config_path} --ensemble-member ${ensemble_member} --scenario ${scenario} --domain ${domain} --scale-factor ${scale_factor} --size ${size} ${years}
}

echo
echo ${domain} ${variable} ${ensemble_member}
echo ${years}
echo

job_id=$(queue_years $job_id ${years})
echo $job_id
