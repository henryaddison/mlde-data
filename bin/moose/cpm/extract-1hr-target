#! /usr/bin/env bash

set -euo pipefail

scenario="rcp85"
scale_factor="4"
frequency="1hr"
collection="land-cpm"
size=64
target_resolution="2.2km-coarsened-4x"

job_memory=56G # memory for slurm job
job_id=0 # ID of job to depend on (0 means no dependency)

while getopts ":d:v:e:j:f:t:" opt; do
  case ${opt} in
    d)
      domain=${OPTARG}
      ;;
    v)
      variable=${OPTARG}
      ;;
    e)
      ensemble_member=${OPTARG}
      ;;
    j)
      job_id=${OPTARG}
      ;;
    f)
      scale_factor=${OPTARG}
      ;;
    t)
      target_resolution=${OPTARG}
      ;;
   \? )
     echo "Invalid Option: -${OPTARG}" 1>&2
     exit 1
     ;;
  esac
done
shift $((OPTIND -1))

years=$@

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

variable_config_path="${SCRIPT_DIR}/../../../config/variables/${frequency}/${collection}/targets/${variable}.yml"

QUEUE_LOTUS_PATH=${SCRIPT_DIR}/../queue-lotus
LOTUS_WRAPPER_PATH=${SCRIPT_DIR}/../lotus-wrapper

function queue_years {
  local job_id=$1
  shift 1;
  local years=$@

  local args=()
  args+=('--variable-config' ${variable_config_path})
  args+=('--ensemble-member' ${ensemble_member})
  args+=('--scenario' ${scenario})
  args+=('--domain' ${domain})
  args+=('--scale-factor' ${scale_factor})
  args+=('--size' ${size})
  args+=('--target-resolution' ${target_resolution})
  ${QUEUE_LOTUS_PATH} -m ${job_memory} -j ${job_id} -d ${SCRIPT_DIR} -- ${LOTUS_WRAPPER_PATH} ${args[@]} ${years}
}

echo
echo ${domain} ${variable} ${ensemble_member}
echo ${years}
echo

job_id=$(queue_years $job_id ${years})
echo $job_id
