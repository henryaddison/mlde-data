#! /usr/bin/env bash

set -euo pipefail

theta=
scenario="rcp85"
frequency="day"
scale_factor="gcm"
collection="land-cpm"

job_id=0 # ID of job to depend on (0 means no dependency)

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

args=()

while getopts ":d:v:e:t:j" opt; do
  case ${opt} in
    d)
      domain=${OPTARG}
      ;;
    v)
      variable=${OPTARG}
      variable_config_path="${SCRIPT_DIR}/../../../config/variables/${frequency}/${collection}/predictors/${variable}.yml"
      args+=('--variable-configs' ${variable_config_path})
      ;;
    e)
      ensemble_member=${OPTARG}
      ;;
    t)
      theta=${OPTARG}
      args+=('--thetas' "${theta}")
      ;;
    j)
      job_id=${OPTARG}
      ;;
   \? )
     echo "Invalid Option: -${OPTARG}" 1>&2
     exit 1
     ;;
  esac
done
shift $((OPTIND -1))

args+=('--domain' ${domain})
args+=('--ensemble-member' ${ensemble_member})
args+=('--scenario' ${scenario})
args+=('--scale-factor' ${scale_factor})

years=$@

QUEUE_LOTUS_PATH=${SCRIPT_DIR}/../queue-lotus
LOTUS_WRAPPER_PATH=${SCRIPT_DIR}/../lotus-wrapper

function queue_years {
  local job_id=$1
  shift 1;
  local years=$@

  ${QUEUE_LOTUS_PATH} -m 32G -j ${job_id} -d ${SCRIPT_DIR} -- ${LOTUS_WRAPPER_PATH} ${args[@]} ${years}
}

echo
echo ${domain} ${variable} ${ensemble_member}
echo ${years}
echo

job_id=$(queue_years $job_id ${years})
echo $job_id
